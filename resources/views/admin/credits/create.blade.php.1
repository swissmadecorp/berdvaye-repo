@extends('layouts.admin-default')

@section ('header')
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css"/> 
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.2.2/css/select.dataTables.min.css"/> 
@endsection

@section ('content')
@inject('countries','App\Libs\Countries')

@if ($orders->count())
<div class="customer_address pb-2">
    <?php 
        $address2 = ''; $returnAmount = 0;
        
        $state_s = $countries->getStateCodeFromCountry($orders[0]->s_state);
        $country = $countries->getCountry($orders[0]->s_country);

        echo $orders[0]->s_company.'<br>';
        echo !empty($orders[0]->s_address1) ? $orders[0]->s_address1 .'<br>' : '';
        echo !empty($orders[0]->s_address2) ? $orders[0]->s_address2 .'<br>' : '';
        echo !empty($orders[0]->s_city) ? $orders[0]->s_city .', '. $state_s . ' ' . $orders[0]->s_zip.'<br>': '';
        
        echo !empty($orders[0]->b_phone) ? $orders[0]->b_phone . '<br>' : '';
        echo !empty($orders[0]->po) ? 'PO #: '.$orders[0]->po . '<br>' : '';
    ?>

</div>
<hr>
<?php $totalOwed = 0; ?>
@foreach($orders as $order)
    @foreach($order->returns->all() as $return)
        @php
            $returnAmount += $return->pivot->amount;
        @endphp
    @endforeach
    <?php 
        $totalOwed+=$order->total-$order->payments->sum('amount')-$returnAmount; 
        
        $credit = $order->customers->first()->credit; 
    ?>

@endforeach

<?php if ($totalOwed==0) {  ?>
            <div class="paid-in-full">&nbsp;</div>
     <?php } ?>

{{ Form::open(array('route'=>'credits.store', 'id' => 'creditForm')) }}
    
    @if ($totalOwed!=0.0)
    <input type="hidden" value="{{$orders[0]->customers()->first()->id}}" name="customer_id" id="customer_id">
    <div class="form-group row">
        <label for="amount-input"  class="col-3 col-form-label">Amount Received *</label>
        <div class="col-9">
        @role('superadmin')
        <input type="text" id="amount"  class='form-control' autofocus name="amount" required/>
        @else
        <span class='form-control p-3'></span>
        @endrole
        </div>    
    </div>
    <div class="form-group row">
        <label for="ref-input" class="col-3 col-form-label">Reference *</label>
        <div class="col-9">
        @role('superadmin')
        <input type="text" id="ref" class='form-control' autofocus name="ref" required/>
        @else
        <span class='form-control p-3'></span>
        @endrole
        </div>    
    </div>    

    @if ($credit && !$credit->apply_order_id) <br><b>Available Credit: <span id="credit" data-amount="{{$credit->amount}}" data-ref="{{$credit->ref}}">{{ '$'.number_format($credit->amount,2) }}</span></b>
    <button class="btn btn-primary btn-sm" id="usecredit">Use</button>
    @endif
@endif
<table id="orders" class="table table-striped table-bordered hover">
    <thead>
        <tr>
        <th></th>
        <th>Order Id</th>
        <th>Invoice Date</th>
        <th>Total Owed</th>
        <th>Amount Paid</th>
        <th>Total Due</th>
        <th>Reference</th>
        </tr>
    </thead>
    <tbody>
    <?php $totalOwed = 0 ?>
    @foreach($orders as $order)     
            <?php $returnAmount = 0;  ?>
            @foreach($order->returns->all() as $return)
                @php
                    $returnAmount += $return->pivot->amount;
                @endphp
            @endforeach
            
            <?php $totalPaid=0;$diff= $order->total-$returnAmount; ?>
            @foreach($order->payments->all() as $payment)
                <tr>
                    <td></td>
                    <td>{{ $order->id }}</td>
                    <td class="text-right">{{ $payment->created_at->format('m/d/Y') }}</td>
                    <td class="text-right">${{ number_format($diff,2) }}</td>
                    <td class="text-right">-${{ number_format($payment->amount,2) }}</td>
                    <td class="text-right">${{ number_format($diff-$payment->amount,2) }}</td>
                    <td>{{ $payment->ref }}</td>
                </tr>
                @php
                    $diff -= $payment->amount;
                @endphp
            @endforeach

            @if ($diff != 0)
       
            <tr>
                <td></td>
                <td>{{ $order->id }}</td>
                <td class="text-right">{{ $order->created_at->format('m/d/Y') }}</td>
                <td class="text-right">${{ number_format($diff,2) }}</td>
                <td class="text-right"></td>
                <td class="text-right">${{ number_format($diff,2) }}</td>
                <td></td>
            </tr>
            @endif
            <?php $totalPaid = 0; $totalOwed+=$order->total-$order->payments->sum('amount')-$returnAmount; ?>
        @endforeach
    </tbody>
    <tfoot>

        @if ($totalOwed!=0.0)
        <tr>
            <td colspan="5"></td>
            <td class="text-right" style="font-weight:bold">Total Due</td>
            <td class="text-right" style="font-weight:bold">$ {{number_format($totalOwed,2) }}</td>
        </tr>
        @else
        <tr>
        <td colspan="7" style="text-align: center; color: green">Paid in full</td>
        </tr>
        @endif
    </tfoot>
</table>

<span id="amountdue" data-amount="{{$totalOwed}}"></span>
@role('superadmin')
{{ Form::submit('Save', array('class' => 'btn btn-primary save')) }}
@endrole

@include('admin.errors')
{{ Form::close() }}

@endsection

@section ('footer')
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.15/fh-3.1.2/datatables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/select/1.2.2/js/dataTables.select.min.js"></script>
@endsection

@section ('jquery')
<script>
    $(document).ready( function() {

        var table = $('#orders').DataTable({
            "deferRender": true,
            columnDefs: [ {
                orderable: false,
                className: 'select-checkbox',
                targets:   0
            }],
            select: {
                style:    'os', // or multi
                selector: 'td:first-child'
            },
            'rowCallback': function( row, data, index ){
                if( data[4].indexOf('-',0)==0) {
                     $(row).find('td:first-child').removeClass('select-checkbox')
                }
            },
            "aaSorting": [[1, 'desc'], [ 6, 'asc']],
            "createdRow": function( row, data, dataIndex){
                if( data[4].indexOf('-',0))
                    $(row).addClass('unpaid');
                else $(row).addClass('paid');
            },
        });

        $('#usecredit').click(function(e) {
            e.preventDefault();
            var totalAmt = $('#credit').attr('data-amount');
            var amtAwed = $('#amountdue').attr('data-amount');
            var ref = $('#credit').attr('data-ref');

            if (totalAmt > amtAwed)
                $('#amount').val(amtAwed);
            else
                $('#amount').val(totalAmt);

            $('#credit').text('$0.00');
            $('#ref').val(ref);
            
        })

        function calculateTotalOwed(dt,indexes) {
            var owed=0;
            var data = dt.rows(indexes).data();
            var inactiveRecord = table.rows('.selected').data();

            if (inactiveRecord[0][4].indexOf('-',0)==-1) {
                
                    $.each(inactiveRecord, function (idx, value) {
                        owed += parseFloat(value[5].replace(/\$|,/g, ''));

                    });
                

                //$('#amount').val(owed)
                $('#ref').focus();
            }
        }

        table.on( 'select', function ( e, dt, type, indexes ) {
            //if ($('#amount').val()) return
            calculateTotalOwed(dt,indexes)
        } );

        table.on( 'deselect', function ( e, dt, type, indexes ) {
            calculateTotalOwed(dt,indexes)
        } );

        $('.save').click( function (e) {
            e.preventDefault();
            var _ids = [];
            ids = table.rows( { selected: true } ).data();
            
            if (!$('#amount').val() || !$('#ref').val()) {
                $('#amount').focus()
                $.alert ('Amount and/or reference cannot be left blank.');
                return;
            } else if (ids[0] == undefined) {
                $.alert ('No Invoice selected.');
                return;
            } 
            
            $.each (ids, function(key,value) {
                id=ids[key][1];
                
                _ids.push(id);
            })

            $.ajax({
                type: "POST",
                url: "{{ URL::route('credit_payment') }}",
                data: { 
                    ids: _ids,
                    form: $('#creditForm').serialize()
                },
                success: function (result) {
                    location.reload(true);
                }
            })
        })
    })
</script>
@endsection
@else
    @section ('content')
    <h2>No Invoice found for this customer.</h2>
    @endsection
@endif